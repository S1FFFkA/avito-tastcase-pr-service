# PR Reviewer Assignment Service

Микросервис для автоматического назначения ревьюверов на Pull Request'ы с управлением командами и участниками.

##  Описание проекта

Сервис реализует систему управления Pull Request'ами с автоматическим назначением ревьюверов из команды автора. Основные возможности:

- **Управление командами**: создание команд с участниками, получение информации о команде
- **Управление пользователями**: установка флага активности, получение списка PR пользователя
- **Pull Request'ы**: создание с автоматическим назначением до 2 ревьюверов, переназначение, слияние
- **Массовая деактивация**: безопасная деактивация участников команды с автоматическим переназначением ревьюверов на открытых PR
- **Метрики**: эндпоинт Prometheus для мониторинга распределения нагрузки между ревьюверами

### Архитектура

Проект следует принципам слоистой архитектуре :
- **Domain**: доменные модели
- **Repository**: работа с базой данных (PostgreSQL)
- **Service**: бизнес-логика 
- **Handlers**: HTTP обработчики
- **Infrastructure**: подключение к БД, миграции

##  Быстрый старт

### Требования

- Docker и Docker Compose
- Go 1.25+ (для локальной разработки)

### Запуск через Docker Compose

Самый простой способ запустить весь стек:

#### создайте файл .env и скопируйте в него содержимое файла .env.examle

```bash
docker-compose up -d --build
```

Сервис будет доступен на `http://localhost:8080`.

При первом запуске автоматически:
- Создаются контейнеры (backend, PostgreSQL, Prometheus)
- Применяются миграции базы данных
- Запускается сервис на порту 8080

### Запуск через Makefile

```bash
# Показать все доступные команды
make help

# Запустить все сервисы
make docker-up

# Остановить все сервисы
make docker-down
```

##  API Документация

Полная OpenAPI спецификация доступна в файле `openapi.yaml`.

Основные эндпоинты:

- `POST /team/add` - Создать команду
- `GET /team/get?team_name=<name>` - Получить команду
- `POST /users/setIsActive` - Установить активность пользователя
- `GET /users/getReview?user_id=<id>` - Получить PR пользователя
- `POST /users/deactivateTeamMembers` - Деактивировать участников команды
- `POST /pullRequest/create` - Создать PR
- `POST /pullRequest/reassign` - Переназначить ревьювера
- `POST /pullRequest/merge` - Слить PR
- `GET /metrics` - Метрики Prometheus

Все эндпоинты требуют заголовок `Authorization: Bearer <token>` (для тестирования можно использовать любой токен).

##  Тестирование

### Unit тесты

```bash
# Запустить все unit тесты
make test-unit

# С покрытием кода
make test-coverage
# Откроет coverage.html в браузере

# Или через PowerShell скрипт
.\run-tests.ps1
```


### Интеграционные тесты

Интеграционные тесты проверяют работу системы в реальных условиях с использованием тестовой базы данных.

```bash
# Автоматический запуск с Docker (рекомендуется)
make integration-tests-docker

# Или вручную через PowerShell скрипт
.\run-integration-tests.ps1

# Или если БД уже запущена
make docker-test-up
make integration-tests
make docker-test-down
```

**Что тестируется:**
- Полный жизненный цикл PR (создание, переназначение, слияние)
- Деактивация участников команды с переназначением ревьюверов
- Атомарность транзакций (откат при ошибках)
- Валидация бизнес-правил (нельзя деактивировать всех участников)

Подробнее о тестах: `integration_tests/INTEGRATION_TESTS_EXPLAIN.md`

##  Дополнительные задания

### 1. Эндпоинт статистики

Реализован эндпоинт `/metrics` для Prometheus, который предоставляет метрику `reviewer_load_distribution` - распределение нагрузки между ревьюверами (гистограмма количества PR на каждого ревьювера).

**Использование:**
```bash
curl http://localhost:8080/metrics
```

**Метрики:**
- `reviewer_load_distribution_bucket` - бакеты гистограммы (0, 1, 2, 3, 5, 10, 15, 20, 30, 50)
- Позволяет отслеживать балансировку нагрузки между ревьюверами

Prometheus настроен для сбора метрик и доступен на `http://localhost:9090`.

###  2. Нагрузочное тестирование

Проведено нагрузочное тестирование с использованием Postman Runner.

**Параметры тестирования:**
- Объём данных: 20 команд, 200 пользователей
- RPS: 5 запросов в секунду
- SLI времени ответа: < 300 мс
- SLI успешности: > 99.9%
- Итераций: 100

**Результаты тестирования:**

| Эндпоинт | Успешных | Неудачных | Успешность |
|----------|----------|-----------|-----------|
| POST Create Team | 200      | 0         | 100% |
| GET Get Team | 200      | 0         | 100% |
| POST Create Pull Request |  200     | 0         | 100% |
| POST Reassign Reviewer |  200     | 0         | 100% |
| POST Merge Pull Request |  200      | 0         | 100% |
| GET Get User Reviews |  200     | 0         | 100% |

**Общая статистика:**
- **Длительность теста:** 6 минуты 13 секунд
- **Среднее время ответа:** 9 мс (значительно ниже SLI 300 мс)
- **Общая успешность:** 100% (1200/1200 запросов успешны)
- **Всего тестовых проверок:** 1200


###  3. Массовая деактивация пользователей

Реализован метод `POST /users/deactivateTeamMembers` для безопасной деактивации участников команды.

**Особенности реализации:**
- **Атомарность**: вся операция выполняется в одной транзакции
- **Автоматическое переназначение**: для каждого открытого PR деактивируемого ревьювера находится новый активный кандидат из той же команды
- **Производительность**: оптимизировано для выполнения < 100 мс при средних объёмах данных
- **Валидация**: нельзя деактивировать всех участников команды (команда должна остаться с активными ревьюверами)

**Пример запроса:**
```json
{
  "team_name": "backend",
  "user_ids": ["user1", "user2"]
}
```

**Ответ:**
```json
{
  "deactivated_user_ids": ["user1", "user2"],
  "reassignments": [
    {
      "pr_id": "pr-1001",
      "old_reviewer_id": "user1",
      "new_reviewer_id": "user3"
    }
  ]
}
```

**Алгоритм:**
1. Получение команды и проверка валидации
2. Нахождение всех открытых PR с деактивируемыми ревьюверами
3. Для каждого PR поиск нового активного кандидата из команды
4. Выполнение всех операций в одной транзакции:
   - Деактивация пользователей
   - Переназначение ревьюверов
   - Обновление флага `need_more_reviewers` при необходимости

### 4. Интеграционное тестирование

Реализован полный набор интеграционных тестов, проверяющих:

Тесты используют отдельную тестовую БД и автоматически управляют Docker контейнерами.

### 5. Конфигурация линтера

Настроен `golangci-lint` с конфигурацией в `.golangci.yml`.

**Включенные линтеры:**
- `errcheck` - проверка обработки ошибок
- `govet` - стандартный линтер Go
- `staticcheck` - статический анализ
- `gosec` - проверка безопасности
- `sqlclosecheck` - проверка закрытия SQL ресурсов
- `prealloc` - оптимизация аллокаций
- `gocyclo` / `gocognit` - проверка сложности кода
- И многие другие...

**Запуск:**
```bash
make lint
```

##  Мониторинг

### Prometheus

Prometheus настроен для сбора метрик и доступен на `http://localhost:9090`.

**Метрики:**
- `reviewer_load_distribution` - распределение нагрузки между ревьюверами
- я также оставил дефолтные метрики от прометеус . возможно вам будет интересно посомтреть 



##  команды

### Обновление зависимостей

```bash
make mod-tidy
```

### Запуск тестов

```bash
# Unit тесты
make test-unit

# Все тесты с покрытием
make test

# Интеграционные тесты
make integration-tests-docker
```

### Линтинг

```bash
make lint
```

Требуется переменная окружения `DB_DSN`:
```bash
export DB_DSN="postgres://user:pass@localhost:5432/dbname?sslmode=disable"
```



### Вопросы, которые возникли при разработке

1. **Что делать, если при деактивации не найден кандидат для переназначения**
   - Решение: устанавливается флаг `need_more_reviewers = true`, операция продолжается. В ответе `new_reviewer_id` будет пустым.

2. **Можно ли деактивировать всех участников команды**
   - Решение: нет, это запрещено валидацией. Команда должна остаться с хотя бы одним активным участником.

3. **Что происходит с PR при удалении команды**
   - Решение: используется каскадное удаление через внешние ключи в БД. Все связанные PR и назначения удаляются автоматически.

4. **Как обрабатывать дубликаты при создании команды**
   - Решение: если `user_id` уже существует в другой команде, возвращается ошибка `INVALID_REQUEST`. Если команда уже существует, возвращается `TEAM_EXISTS`.


